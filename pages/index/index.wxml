<!--pages/index/index.wxml-->
<view class="container">
  <!-- 1. 加载状态 -->
  <view class="status-container" wx:if="{{isLoading}}">
    <view class="loading-text">正在加载您的信息...</view>
  </view>

  <!-- 2. 加载完成后的界面 -->
  <block wx:else>
    <!-- 2.1 如果用户没有家族 -->
    <view class="status-container" wx:if="{{families.length === 0}}">
      <view class="empty-text">您还未加入任何家族</view>
      <view class="empty-tip">可以立即创建一个，邀请家人加入</view>
      <button class="create-btn" bindtap="showCreateFamilyModal">创建我的家族</button>
    </view>

    <!-- 2.2 如果用户有家族 -->
    <block wx:else>
      <view class="family-profile">
      <image class="family-banner" src="{{activeFamily.banner || '/static/default_banner.jpg'}}" mode="aspectFill"></image>
      <image class="family-avatar" src="{{activeFamily.avatar || '/static/default_family_avatar.jpg'}}" mode="aspectFill"></image>
      <view class="family-name-display">{{activeFamily.name}}</view>
    </view>
      <!-- 搜索栏 (移到顶部) -->
      <view class="search-wrapper" bindtap="navigateToSearch">
        <view class="search-fake-input">
          <text class="search-icon">🔍</text>
          <text class="search-placeholder">在「{{activeFamilyName}}」中搜索...</text>
        </view>
      </view>

      <!-- 族谱树容器 -->
      <scroll-view scroll-y="true" class="tree-scroll-view">
        <view class="tree-container" wx:if="{{activeFamilyData}}">
          <member-card 
            member="{{activeFamilyData}}"
            user-role="{{currentUserRole}}"
          ></member-card>
        </view>
        <view class="status-container" wx:elif="{{isTreeLoading}}">
            <view class="loading-text">正在加载族谱...</view>
        </view>
        <view class="status-container" wx:else>
            <view class="empty-text">该家族暂无成员数据</view>
            <view class="empty-tip">请先添加家族的始祖</view>
            <button class="create-btn" bindtap="showAddMemberModal">添加始祖</button>
        </view>
      </scroll-view>

      <!-- 新增：底部导航栏 -->
      <view class="bottom-nav">
        <view class="nav-item" bindtap="switchFamilyBySheet">
          <view class="nav-icon">🗂️</view>
          <view class="nav-text">切换家族</view>
        </view>
        <view class="nav-item" bindtap="showActionSheet">
          <view class="nav-icon">⚙️</view>
          <view class="nav-text">更多操作</view>
        </view>
      </view>

    </block>
  </block>


  <!-- 创建家族的弹窗 -->
  <view class="modal-mask" wx:if="{{showModal}}" bindtap="hideCreateFamilyModal">
    <view class="modal-content" catchtap>
      <view class="modal-title">创建新家族</view>
      <input class="modal-input" placeholder="请输入家族名称" model:value="{{newFamilyName}}"/>
      <textarea class="modal-textarea" placeholder="请输入家族简介（选填）" model:value="{{newFamilyDesc}}"/>
      <button class="modal-confirm-btn" bindtap="handleCreateFamily">确认创建</button>
    </view>
  </view>

  <!-- 添加成员的弹窗 -->
  <view class="modal-mask" wx:if="{{showAddMemberModal}}" bindtap="hideAddMemberModal">
    <view class="modal-content" catchtap>
      <view class="modal-title">添加始祖</view>
      <input class="modal-input" placeholder="请输入始祖姓名" value="{{newMember.name}}" bindinput="onNameInput"/>
      <radio-group class="radio-group" bindchange="onGenderChange">
        <label class="radio"><radio value="male" checked/> 男</label>
        <label class="radio"><radio value="female"/> 女</label>
      </radio-group>
      <button class="modal-confirm-btn" bindtap="handleCreateMember">确认添加</button>
    </view>
  </view>

</view>
