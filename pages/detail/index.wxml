<!--pages/detail/index.wxml-->
<view class="loading-container" wx:if="{{isLoading}}">
  <view>æ­£åœ¨åŠ è½½æˆå‘˜ä¿¡æ¯...</view>
</view>

<view class="container" wx:else>
  <view class="card info-card" wx:if="{{memberInfo}}">
    <!-- é¡¶éƒ¨å§“åå’Œç¼–è¾‘æŒ‰é’® -->
    <view class="info-header">
      <view class="name-gender">
        <view wx:if="{{!isEditing}}" class="name">{{memberInfo.name}}</view>
        <input wx:else class="name-input" value="{{editableInfo.name}}" data-field="name" bindinput="handleInputChange" />
        <view class="gender {{memberInfo.gender}}">{{memberInfo.gender === 'male' ? 'ç”·' : 'å¥³'}}</view>
      </view>
      <text style="flex:1"></text>
      <!-- å‡çº§æƒé™åˆ¤æ–­ï¼šä½¿ç”¨ canEdit å˜é‡ -->
      <block wx:if="{{canEdit}}">
        <button wx:if="{{!isEditing}}" class="edit-btn" size="mini" bindtap="toggleEditMode">ç¼–è¾‘</button>
        <button wx:else class="save-btn" size="mini" bindtap="handleSave">ä¿å­˜</button>
      </block>
    </view>

    <!-- è¯¦ç»†ä¿¡æ¯åˆ—è¡¨ -->
    <view class="info-item" wx:if="{{isEditing}}">
      <view class="label">çŠ¶æ€</view>
      <picker range="{{statusOptions}}" range-key="text" value="{{editableInfo.status === 'alive' ? 0 : 1}}" data-field="status" bindchange="handlePickerChange">
        <view class="value picker-value">{{editableInfo.status === 'alive' ? 'ğŸƒ åœ¨ä¸–' : 'ğŸ•¯ï¸ å·²æ•…'}}</view>
      </picker>
    </view>

    <view class="info-item" wx:if="{{!isEditing&&memberInfo.status != 'alive'}}">
      <view class="label">çŠ¶æ€</view>
      <view class="value">ğŸ•¯ï¸ å·²æ•…</view>
    </view>

    <view class="info-item" wx:if="{{editableInfo.status === 'alive'}}">
      <view class="label">å‡ºç”Ÿæ—¥æœŸ</view>
      <input wx:if="{{isEditing}}" class="value-input" value="{{editableInfo.birth_date}}" data-field="birth_date" bindinput="handleInputChange" placeholder="å¦‚:1888-08-08" />
      <view wx:else class="value">{{memberInfo.birth_date || 'æœªå¡«å†™'}}</view>
    </view>

    <view class="info-item" wx:else>
      <view class="label" style="flex:1">ç”Ÿäº</view>
      <input wx:if="{{isEditing}}" class="value-input" style="flex:3" value="{{editableInfo.birth_date}}" data-field="birth_date" bindinput="handleInputChange" placeholder="å¦‚:1888-08-08" />
      <view wx:else class="value">{{memberInfo.birth_date || 'æœªå¡«å†™'}}</view>
      <view style="flex:1"></view>
      <view class="label" style="flex:1">å’äº</view>
      <input wx:if="{{isEditing}}" class="value-input" style="flex:3" value="{{editableInfo.death_date}}" data-field="death_date" bindinput="handleInputChange" placeholder="å¦‚:1888-08-08" />
      <view wx:else class="value">{{memberInfo.death_date || 'æœªå¡«å†™'}}</view>
    </view>
    <view class="info-item" wx:if="{{editableInfo.status === 'alive'}}">
      <view class="label">è”ç³»ç”µè¯</view>
      <input wx:if="{{isEditing}}" class="value-input" value="{{editableInfo.phone}}" data-field="phone" bindinput="handleInputChange" placeholder="è¯·è¾“å…¥" />
      <view wx:else class="value">{{memberInfo.phone || 'æœªå¡«å†™'}}</view>
    </view>
    <!-- å¾®ä¿¡å·å­—æ®µå·²å‡çº§ -->
    <view class="info-item" wx:if="{{editableInfo.status === 'alive'}}">
      <view class="label">å¾®ä¿¡å·</view>
      <input wx:if="{{isEditing}}" class="value-input" value="{{editableInfo.wechat_id}}" data-field="wechat_id" bindinput="handleInputChange" placeholder="è¯·è¾“å…¥" />
      <view wx:else class="value">
        <text>{{memberInfo.wechat_id || 'æœªå¡«å†™'}}</text>
        <text wx:if="{{memberInfo.is_linked}}" class="linked-tag">å·²ç»‘å®š</text>
      </view>
    </view>

    <view class="info-item" wx:if="{{editableInfo.status === 'alive'}}">
      <view class="label">ç°å±…åœ°å€</view>
      <input wx:if="{{isEditing}}" class="value-input" value="{{editableInfo.current_address}}" data-field="current_address" bindinput="handleInputChange" placeholder="è¯·è¾“å…¥" />
      <view wx:else class="value">{{memberInfo.current_address || 'æœªå¡«å†™'}}</view>
    </view>
    <view class="info-item" wx:else>
      <view class="label">å¢“åœ°ä½ç½®</view>
      <input wx:if="{{isEditing}}" class="value-input" value="{{editableInfo.current_address}}" data-field="current_address" bindinput="handleInputChange" placeholder="è¯·è¾“å…¥" />
      <view wx:else class="value">{{memberInfo.current_address || 'æœªå¡«å†™'}}</view>
    </view>
  </view>

  <!-- èº«ä»½è®¤é¢†åŒºåŸŸ -->
  <view class="card claim-card" wx:if="{{canClaim}}">
    <view class="claim-text">è¿™çœ‹èµ·æ¥æ˜¯æ‚¨åœ¨æ—è°±ä¸­çš„èº«ä»½ï¼Œæ˜¯å¦ç»‘å®šï¼Ÿ</view>
    <button class="claim-btn" bindtap="handleClaimProfile">è¿™æ˜¯æˆ‘ï¼Œç»‘å®šèº«ä»½</button>
  </view>

  <!-- å…³ç³»å¡ç‰‡ -->
  <view class="card relation-card" wx:if="{{memberInfo}}">
    <view class="relation-header">
      <view class="relation-title">å®¶åº­å…³ç³»</view>
      <view style="flex:1"></view>
      <button class="add-relation-btn" size="mini" wx:if="{{userRole === 'admin' || userRole === 'editor'}}" bindtap="showAddSpouseModal">ï¼‹ é…å¶</button>
      <button class="add-relation-btn" size="mini" style="margin-left: 5rpx;"  wx:if="{{userRole === 'admin' || userRole === 'editor'}}" bindtap="showAddChildModal">ï¼‹ å­å¥³</button> 
    </view>
    <view class="info-item" wx:if="{{relations.father}}">
      <view class="label">çˆ¶äº²</view>
      <view class="value link" bindtap="navigateToMember" data-id="{{relations.father.id}}">{{relations.father.name}}</view>
    </view>
    <view class="info-item" wx:if="{{relations.mother}}">
      <view class="label">æ¯äº²</view>
      <view class="value link" bindtap="navigateToMember" data-id="{{relations.mother.id}}">{{relations.mother.name}}</view>
    </view>
    <view class="info-item" wx:if="{{relations.spouses && relations.spouses.length > 0}}">
      <view class="label">é…å¶</view>
      <text wx:for="{{relations.spouses}}" wx:key="id" class="value link" bindtap="navigateToMember" data-id="{{item.id}}">{{item.name}} </text>
    </view>
    <view class="info-item" wx:if="{{relations.children && relations.children.length > 0}}">
      <view class="label">å­å¥³</view>
      <view class="value">
        <text wx:for="{{relations.children}}" wx:key="id" class="value link" bindtap="navigateToMember" data-id="{{item.id}}">{{item.name}} </text>
      </view>
    </view>
  </view>

  <button wx:if="{{isEditing}}" class="cancel-btn" bindtap="toggleEditMode">å–æ¶ˆ</button>

  <view class="modal-mask" wx:if="{{showAddChildModal}}" bindtap="hideAddChildModal">
    <view class="modal-content" catchtap>
      <view class="modal-title">æ·»åŠ å­å¥³</view>
      <input class="modal-input" placeholder="è¯·è¾“å…¥å­å¥³å§“å" value="{{newChild.name}}" bindinput="onChildNameInput" />
      <radio-group class="radio-group" bindchange="onChildGenderChange">
        <label class="radio">
          <radio value="male" checked /> ç”·
        </label>
        <label class="radio">
          <radio value="female" /> å¥³
        </label>
      </radio-group>
      <input class="modal-input" placeholder="å‡ºç”Ÿæ—¥æœŸ(é€‰å¡«)" value="{{newChild.birth_date}}" bindinput="onChildBirthDateInput" />
      <button class="modal-confirm-btn" bindtap="handleCreateChild">ç¡®è®¤æ·»åŠ </button>
    </view>
  </view>

  <view class="modal-mask" wx:if="{{showAddSpouseModal}}" bindtap="hideAddSpouseModal">
    <view class="modal-content" catchtap>
      <view class="modal-title">æ·»åŠ é…å¶</view>
      <input class="modal-input" placeholder="æœç´¢å®¶æ—æˆå‘˜å§“å..." value="{{spouseSearchName}}" bindinput="onSpouseSearchInput" />
      <scroll-view scroll-y="true" class="search-results" wx:if="{{spouseSearchResults.length > 0}}">
        <view class="result-item" wx:for="{{spouseSearchResults}}" wx:key="id" bindtap="handleSelectSpouse" data-spouse="{{item}}">
          <view>{{item.name}} ({{item.gender === 'male' ? 'ç”·' : 'å¥³'}})</view>
          <view class="result-birth">{{item.birth_date || 'ç”Ÿæ—¥æœªè¯¦'}}</view>
        </view>
      </scroll-view>
      <view class="divider"> æˆ– </view>
      <view class="create-new-tip">ç›´æ¥åˆ›å»ºæ–°æˆå‘˜ä½œä¸ºé…å¶</view>
      <input class="modal-input" placeholder="è¯·è¾“å…¥é…å¶å§“å" value="{{newSpouse.name}}" bindinput="onNewSpouseInput" data-field="name" />
      <radio-group class="radio-group" bindchange="onNewSpouseInput" data-field="gender">
        <label class="radio">
          <radio value="male" checked="{{newSpouse.gender === 'male'}}" /> ç”·
        </label>
        <label class="radio">
          <radio value="female" checked="{{newSpouse.gender === 'female'}}" /> å¥³
        </label>
      </radio-group>
      <input class="modal-input" placeholder="å‡ºç”Ÿæ—¥æœŸ(é€‰å¡«)" value="{{newSpouse.birth_date}}" bindinput="onNewSpouseInput" data-field="birth_date" />
      <button class="modal-confirm-btn" bindtap="handleCreateAndLinkSpouse">åˆ›å»ºå¹¶å…³è”</button>
    </view>
  </view>
</view>